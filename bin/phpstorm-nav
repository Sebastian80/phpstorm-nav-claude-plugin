#!/bin/bash
#
# phpstorm-nav - Direct CLI for JetBrains Serena Plugin
#
# Bypasses Serena MCP layer, talks directly to plugin's HTTP API.
# Zero dependencies (Python stdlib only).
#
# Usage:
#   phpstorm-nav setup              # First-time setup (creates symlink, adds permission)
#   phpstorm-nav status             # Check connection
#   phpstorm-nav find ClassName     # Find symbol
#   phpstorm-nav refs ClassName     # Find references
#   phpstorm-nav rename Old New     # IDE refactor rename
#

set -e

SCRIPT_PATH="$(realpath "$0")"
PLUGIN_DIR="$(dirname "$(dirname "$SCRIPT_PATH")")"
LOCAL_BIN="$HOME/.local/bin"
SYMLINK="$LOCAL_BIN/phpstorm-nav"
CLAUDE_SETTINGS="$HOME/.claude/settings.local.json"

log() {
    echo "[phpstorm-nav] $*" >&2
}

ensure_symlink() {
    if [[ ! -L "$SYMLINK" ]] || [[ "$(readlink "$SYMLINK" 2>/dev/null)" != "$SCRIPT_PATH" ]]; then
        mkdir -p "$LOCAL_BIN"
        ln -sf "$SCRIPT_PATH" "$SYMLINK"
        log "Installed: phpstorm-nav -> $SCRIPT_PATH"
    fi
}

add_claude_permission() {
    local perm="$1"

    if ! command -v jq &>/dev/null; then
        return
    fi

    if [[ ! -f "$CLAUDE_SETTINGS" ]]; then
        mkdir -p "$(dirname "$CLAUDE_SETTINGS")"
        echo '{"permissions":{"allow":[]}}' > "$CLAUDE_SETTINGS"
    fi

    if jq -e ".permissions.allow | index(\"$perm\")" "$CLAUDE_SETTINGS" &>/dev/null; then
        return
    fi

    local tmp=$(mktemp)
    if jq ".permissions.allow += [\"$perm\"]" "$CLAUDE_SETTINGS" > "$tmp"; then
        mv "$tmp" "$CLAUDE_SETTINGS"
        log "Added Claude permission: $perm"
    else
        rm -f "$tmp"
    fi
}

run_cli() {
    python3 - "$@" << 'PYTHON_SCRIPT'
import argparse
import json
import socket
import sys
import urllib.request
import urllib.error
from typing import Any

BASE_PORT = 0x5EA2  # 24226
MAX_PORT_SCAN = 20
TIMEOUT = 120


class PhpStormClient:
    def __init__(self, port: int):
        self.base_url = f"http://127.0.0.1:{port}"

    def _request(self, endpoint: str, data: dict | None = None) -> dict[str, Any]:
        url = f"{self.base_url}{endpoint}"
        if data is not None:
            req = urllib.request.Request(
                url,
                data=json.dumps(data).encode("utf-8"),
                headers={"Content-Type": "application/json", "Accept": "application/json"},
                method="POST"
            )
        else:
            req = urllib.request.Request(url, headers={"Accept": "application/json"}, method="GET")
        with urllib.request.urlopen(req, timeout=TIMEOUT) as resp:
            return json.loads(resp.read().decode("utf-8"))

    def status(self) -> dict[str, Any]:
        return self._request("/status")

    def find_symbol(self, name_path: str, relative_path: str | None = None,
                    include_body: bool = False, depth: int = 0, search_deps: bool = False) -> dict[str, Any]:
        return self._request("/findSymbol", {
            "namePath": name_path, "relativePath": relative_path, "includeBody": include_body,
            "depth": depth, "includeLocation": True, "searchDeps": search_deps,
        })

    def find_references(self, name_path: str, relative_path: str) -> dict[str, Any]:
        return self._request("/findReferences", {"namePath": name_path, "relativePath": relative_path})

    def get_overview(self, relative_path: str, depth: int = 1) -> dict[str, Any]:
        return self._request("/getSymbolsOverview", {"relativePath": relative_path, "depth": depth})

    def rename_symbol(self, name_path: str, relative_path: str, new_name: str,
                      rename_in_comments: bool = False, rename_in_text: bool = False) -> dict[str, Any]:
        return self._request("/renameSymbol", {
            "namePath": name_path, "relativePath": relative_path, "newName": new_name,
            "renameInComments": rename_in_comments, "renameInTextOccurrences": rename_in_text,
        })

    def refresh_file(self, relative_path: str) -> dict[str, Any]:
        return self._request("/refreshFile", {"relativePath": relative_path})


def find_plugin() -> PhpStormClient | None:
    for port in range(BASE_PORT, BASE_PORT + MAX_PORT_SCAN):
        try:
            client = PhpStormClient(port)
            client.status()
            return client
        except (urllib.error.URLError, socket.timeout, ConnectionRefusedError, OSError):
            continue
    return None


def format_symbol(sym: dict, indent: int = 0) -> str:
    prefix = "  " * indent
    kind = sym.get("type", sym.get("kind", "?"))
    name_path = sym.get("namePath", "")
    name = name_path.split("/")[-1] if name_path else sym.get("name", "?")
    path = sym.get("relativePath", "")
    text_range = sym.get("textRange", {})
    start_pos = text_range.get("startPos", {})
    line = start_pos.get("line", sym.get("line", ""))
    loc = f"{path}:{line}" if line else path
    out = f"{prefix}{kind:12} {name:40} {loc}"
    body = sym.get("body")
    if body:
        out += f"\n{prefix}{'─' * 60}\n"
        for ln in body.split("\n")[:30]:
            out += f"{prefix}  {ln}\n"
        if body.count("\n") > 30:
            out += f"{prefix}  ... (truncated)\n"
        out += f"{prefix}{'─' * 60}"
    for child in sym.get("children", []):
        out += "\n" + format_symbol(child, indent + 1)
    return out


def cmd_status(client, args):
    result = client.status()
    print(f"Connected to JetBrains plugin at {client.base_url}")
    print(f"Project root: {result.get('projectRoot', '?')}")
    return 0


def cmd_find(client, args):
    result = client.find_symbol(args.pattern, args.path, args.body, args.depth, args.deps)
    symbols = result.get("symbols", [])
    if not symbols:
        print(f"No symbols found for: {args.pattern}", file=sys.stderr)
        return 1
    print(f"Found {len(symbols)} symbol(s):\n")
    for sym in symbols:
        print(format_symbol(sym))
        print()
    return 0


def cmd_refs(client, args):
    find_result = client.find_symbol(args.pattern, include_body=False)
    symbols = find_result.get("symbols", [])
    if not symbols:
        print(f"Symbol not found: {args.pattern}", file=sys.stderr)
        return 1
    sym = symbols[0]
    result = client.find_references(sym.get("namePath", args.pattern), sym.get("relativePath", ""))
    refs = result.get("symbols", [])
    if not refs:
        print(f"No references found for: {args.pattern}")
        return 0
    print(f"Found {len(refs)} reference(s) to {args.pattern}:\n")
    for ref in refs:
        print(format_symbol(ref))
        print()
    return 0


def cmd_overview(client, args):
    result = client.get_overview(args.path, args.depth)
    symbols = result.get("symbols", [])
    if not symbols:
        print(f"No symbols in: {args.path}", file=sys.stderr)
        return 1
    print(f"Symbols in {args.path}:\n")
    for sym in symbols:
        print(format_symbol(sym))
        print()
    return 0


def cmd_rename(client, args):
    find_result = client.find_symbol(args.symbol, include_body=False)
    symbols = find_result.get("symbols", [])
    if not symbols:
        print(f"Symbol not found: {args.symbol}", file=sys.stderr)
        return 1
    if len(symbols) > 1:
        print(f"Multiple symbols found for '{args.symbol}':", file=sys.stderr)
        for i, sym in enumerate(symbols):
            print(f"  [{i}] {sym.get('relativePath', '?')}", file=sys.stderr)
        print("\nUse --path to specify which one.", file=sys.stderr)
        return 1
    sym = symbols[0]
    print(f"Renaming {sym.get('namePath', args.symbol)} -> {args.new_name}")
    print(f"  in: {sym.get('relativePath', '')}")
    try:
        client.rename_symbol(sym.get("namePath", args.symbol), sym.get("relativePath", ""),
                             args.new_name, args.comments, args.text)
        print("Rename successful!")
        return 0
    except Exception as e:
        print(f"Rename failed: {e}", file=sys.stderr)
        return 1


def cmd_refresh(client, args):
    try:
        client.refresh_file(args.path)
        print(f"Refreshed: {args.path}")
        return 0
    except Exception as e:
        print(f"Refresh failed: {e}", file=sys.stderr)
        return 1


def main():
    parser = argparse.ArgumentParser(description="Direct CLI for JetBrains Serena Plugin")
    subparsers = parser.add_subparsers(dest="command", required=True)

    subparsers.add_parser("status", help="Check plugin connection")

    p_find = subparsers.add_parser("find", help="Find symbol by name")
    p_find.add_argument("pattern", help="Symbol name")
    p_find.add_argument("--path", "-p", help="Restrict to path")
    p_find.add_argument("--body", "-b", action="store_true", help="Include source")
    p_find.add_argument("--depth", "-d", type=int, default=0, help="Children depth")
    p_find.add_argument("--deps", action="store_true", help="Search deps")

    p_refs = subparsers.add_parser("refs", help="Find references")
    p_refs.add_argument("pattern", help="Symbol name")

    p_over = subparsers.add_parser("overview", help="File overview")
    p_over.add_argument("path", help="File path")
    p_over.add_argument("--depth", "-d", type=int, default=1, help="Depth")

    p_rename = subparsers.add_parser("rename", help="Rename symbol")
    p_rename.add_argument("symbol", help="Symbol to rename")
    p_rename.add_argument("new_name", help="New name")
    p_rename.add_argument("--path", "-p", help="Specific file")
    p_rename.add_argument("--comments", "-c", action="store_true")
    p_rename.add_argument("--text", "-t", action="store_true")

    p_refresh = subparsers.add_parser("refresh", help="Refresh file in IDE")
    p_refresh.add_argument("path", help="File path")

    args = parser.parse_args()
    client = find_plugin()
    if not client:
        print("Error: Cannot connect to JetBrains plugin", file=sys.stderr)
        print("Make sure PhpStorm is running with Serena plugin.", file=sys.stderr)
        return 1

    cmds = {"status": cmd_status, "find": cmd_find, "refs": cmd_refs,
            "overview": cmd_overview, "rename": cmd_rename, "refresh": cmd_refresh}
    return cmds[args.command](client, args)


if __name__ == "__main__":
    sys.exit(main())
PYTHON_SCRIPT
}

# Main command router
case "${1:-}" in
    setup)
        log "Setting up phpstorm-nav..."
        ensure_symlink
        add_claude_permission 'Bash(phpstorm-nav:*)'
        log "Done. Run 'phpstorm-nav status' to verify connection."
        ;;
    *)
        run_cli "$@"
        ;;
esac
